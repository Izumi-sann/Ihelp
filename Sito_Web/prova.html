<!DOCTYPE html>
<html lang="en">

<!-------------------------------------------HEAD DEL SITO---------------------------------------------------->

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leaflet Map with Zoom-Based Pin Visibility</title>

  <!-----------------------------------------STILI DELLA PAGINA----------------------------------------------->

    <!--------------------LEAFLET CSS----------------------------->

      <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!------------------------------------------------------------>


    <!--------------------PROVA_2 CSS----------------------------->

      <link rel="stylesheet" href="PROVA2.css" />

    <!------------------------------------------------------------>

  <!---------------------------------------------------------------------------------------------------------->

  </head>

<!----------------------------------------------FINE HEAD----------------------------------------------------->




<!--------------------------------------------BODY DEL SITO--------------------------------------------------->

<body>

<!--------------------------------------------MENU' GRAFICO--------------------------------------------------->

  <div id="MAPS">
      <div id="BARRA_SUP">
          <div class="BARRA_RICERCA">
              <div class="MENU">  
                <input type="checkbox" id="menu-toggle" class="menu-checkbox">
                  <label for="menu-toggle" class="menu-hamburger">
                      <span></span>
                      <span></span>
                      <span></span>
                  </label>
                  <div class="menu-items">
                      <button class="close-menu">&times;</button>
                      <a href="#Account" data-key="account">Account</a>

  <!-------------------------------------POPUP SERVIZI PREFERITI--------------------------------------------->

  <button class="Lingua" onclick="openPopupPref()" data-key="preferiti">Preferiti</button>
      <div class="overlay-disp-pref" id="colorPopup-pref">
        <div class="popup-disp-pref">
            <h2 style="color: black;" id="popupTitle-pref" data-key="srv">Scegli servizio</h2>

            <!-- Barra delle tab sopra il popup -->
            <div class="popup-header-disp-pref">
                <button id="btnO" onclick="setActiveButton('O')">O</button>
                <button id="btnX" onclick="setActiveButton('X')">X</button>
                <button id="btnT" onclick="setActiveButton('T')">T</button>
            </div>

            <!-- Griglia dei servizi -->
            <div class="services-grid-disp-pref">
                <div class="service-item-disp-pref" onclick="selectColor('red')">
                    <img src="RED_ICON.png" alt="Rosso">
                    <h2 style="color: black; font-size: 13px; font-weight: lighter;" data-key="parcheggio_occupato"></h2>
                </div>
                <div class="service-item-disp-pref" onclick="selectColor('green')">
                    <img src="GREEN_ICON.png" alt="Verde">
                    <h2 style="color: black; font-size: 13px; font-weight: lighter;" data-key="ascensore"></h2>
                </div>
                <div class="service-item-disp-pref" onclick="selectColor('blue')">
                    <img src="BLUE_ICON.png" alt="Blu">
                    <h2 style="color: black; font-size: 13px; font-weight: lighter;" data-key="parcheggio_libero"></h2>
                </div>
                <div class="service-item-disp-pref" onclick="selectColor('pink')">
                    <img src="PINK_ICON.png" alt="Rosa">
                    <h2 style="color: black; font-size: 13px; font-weight: lighter;" data-key="hotel"></h2>
                </div>
                <div class="service-item-disp-pref" onclick="selectColor('orange')">
                    <img src="ORANGE_ICON.png" alt="Arancione">
                    <h2 style="color: black; font-size: 13px; font-weight: lighter;" data-key="servizi_igenici"></h2>
                </div>
            </div>

            <!-- Pulsante Chiudi in basso a destra -->
            <div class="popup-footer-disp-pref">
                <button onclick="closePopupPref()">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- <div id="map"></div> -->

    <!-- <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script> -->
    
    <script>

        function createIcon(color) {
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="width: 20px; height: 20px; background: ${color}; border-radius: 50%;"></div>`
            });
        }

        function openPopupPref() {
            document.getElementById('colorPopup-pref').style.display = 'flex';
            setActiveButton('O');
        }

        function closePopupPref() {
            document.getElementById('colorPopup-pref').style.display = 'none';
        }

        function setActiveButton(button) {
            activeButton = button;
            let title = document.getElementById('popupTitle-pref');
            
            // Aggiungi la classe "active" al pulsante attivo e rimuovila dagli altri
            document.querySelectorAll('.popup-header-disp-pref button').forEach((btn) => {
                if (btn.textContent === button) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        function selectColor(color) {
            let button = activeButton;
            let previousColor = selectedColors[button];
            if (previousColor && previousColor !== color) {
                markers_pref[previousColor].addTo(map);
                shownMarkers_pref[button] = null;
            }

            for (let key in selectedColors) {
                if (selectedColors[key] === color) {
                    markers_pref[color].addTo(map);
                    selectedColors[key] = null;
                    document.getElementById('btn' + key).style.background = null;
                }
            }
            selectedColors[button] = color;
            updateButtonsColors();
        }

        function updateButtonsColors() {
            let allButtons = ['O', 'X', 'T'];
            let usedColors = Object.values(selectedColors).filter(c => c !== null);
            allButtons.forEach(button => {
                let buttonElement = document.getElementById('btn' + button + 'Out');
                if (selectedColors[button]) {
                    buttonElement.style.backgroundColor = selectedColors[button];
                } else {
                    buttonElement.style.backgroundColor = '#007bff'; // Colore predefinito
                }
            });
        }

        
    </script>
                      

  <!-------------------------------------POPUP SERVIZI DISPONIBILI------------------------------------------->

  <script>
    function openPopupDisp() {
        document.getElementById('servicesPopupDisp').style.display = 'flex';
    }

    function closePopupDisp() {
        document.getElementById('servicesPopupDisp').style.display = 'none';
    }

    function hideMarkerByImage(imageSrc) {
        for (let key in markers_pref) {
            if (key.includes(imageSrc)) {
                map.removeLayer(markers_pref[key]);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".service-item-disp img").forEach(img => {
            img.addEventListener("click", function() {
                hideMarkerByImage(this.src);
            });
        });
    });
</script>

<button class="Lingua" onclick="openPopupDisp()" data-key="servizi">Servizi</button>
<div class="overlay-disp" id="servicesPopupDisp">
    <div class="popup-disp">
        <h2 style="color: black;" data-key="servizidisponibili">Servizi Disponibili</h2>
        <div class="services-grid-disp">
            <div class="service-item-disp">
                <img src="RED_ICON.png" alt="Emergenze">
                <p style="color: black; font-size: 13px;" data-key="parcheggio_occupato">Emergenze</p>
            </div>
            <div class="service-item-disp">
                <img src="GREEN_ICON.png" alt="Ascensore">
                <p style="color: black; font-size: 13px;" data-key="ascensore">Ascensore</p>
            </div>
            <div class="service-item-disp">
                <img src="BLUE_ICON.png" alt="Parcheggio">
                <p style="color: black; font-size: 13px;" data-key="parcheggio_libero">Parcheggio</p>
            </div>
        </div>
        <div class="popup-footer-disp">
            <button onclick="closePopupDisp()" data-key="chiudi">Chiudi</button>
        </div>
    </div>
</div>

  <!------------------------------------------------------------------------------------------------------------->

  <!--------------------------------------------POPUP LINGUE----------------------------------------------------->

                      <button class="Lingua" onclick="openPopup()" data-key="seleziona_lingua">Seleziona Lingua</button>
                      <div class="overlay" id="languagePopup">
                          <div class="popup">
                              <div class="popup-header" data-key="seleziona_lingua">Seleziona la tua lingua</div>
                              <div class="popup-content">
                                  <ul>
                                      <li onclick="changeLanguage('it')">Italiano</li>
                                      <li onclick="changeLanguage('en')">English</li>
                                      <li onclick="changeLanguage('fr')">Français</li>
                                      <li onclick="changeLanguage('es')">Español</li>
                                      <li onclick="changeLanguage('de')">Deutsch</li>
                                      <li onclick="changeLanguage('pt')">Português</li>
                                      <li onclick="changeLanguage('zh')">中文</li>
                                      <li onclick="changeLanguage('ja')">日本語</li>
                                      <li onclick="changeLanguage('ko')">한국어</li>
                                      <li onclick="changeLanguage('ru')">Русский</li>
                                      <li onclick="changeLanguage('ar')">عربي</li>
                                  </ul>
                              </div>
                              <div class="popup-footer">
                                  <button onclick="closePopup()" data-key="chiudi">Chiudi</button>
                              </div>
                          </div>
                      </div>


                      <a href="#Impostazioni" data-key="impostazioni">Impostazioni</a>
                      <a href="#Informazioni" data-key="informazioni">Info su IHELP</a>
                      <a href="#Partner" data-key="partner">Partner</a>
                      <a href="#Donazioni" data-key="donazioni">Donazioni</a>
                      <a href="#Assistenza" data-key="assistenza">Assistenza</a>
                      <a href="#Contattaci" data-key="contattaci">Contattaci</a>
                  </div>
              </div>
              <input placeholder="Cerca su IHELP" class="input" type="text" data-key="placeholder">
              <svg viewBox="0 0 24 24" class="search__icon">
                <g>
                  <path d="M21.53 20.47l-3.66-3.66C19.195 15.24 20 13.214 20 11c0-4.97-4.03-9-9-9s-9 4.03-9 9 4.03 9 9 9c2.215 0 4.24-.804 5.808-2.13l3.66 3.66c.147.146.34.22.53.22s.385-.073.53-.22c.295-.293.295-.767.002-1.06zM3.5 11c0-4.135 3.365-7.5 7.5-7.5s7.5 3.365 7.5 7.5-3.365 7.5-7.5 7.5-7.5-3.365-7.5-7.5z">
                  </path>
                </g>
              </svg>
            </div>
        </div>
        <div class="button-container">
            <input type="checkbox" id="menu-toggle" class="checkbox"> 
            <label for="menu-toggle" class="button-menu"></label>
        
            <button id="btnOOut" class="color-button-pref ch-option-a" onclick="toggleMarker('O')">O</button>
            <button id="btnXOut" class="color-button-pref ch-option-b" onclick="toggleMarker('X')">X</button>
            <button id="btnTOut" class="color-button-pref ch-option-c" onclick="toggleMarker('T')">T</button>
            
        </div>

  </div>

  <!------------------------------------------------------------------------------------------------------------->


  <script src="button.js" defer></script>
  <script src="servizi.js" defer></script>
  <script src="servizi_disponibili.js" defer></script>
  <script src="translations.js" defer></script>
  
  <script>


    /*-------------------------MENU' SERVIZI-----------------------------*/

        function openPopupDisp() {
            document.getElementById("servicesPopupDisp").style.display = "flex";
        }

        function closePopupDisp() {
            document.getElementById("servicesPopupDisp").style.display = "none";
        }
    
    /*-------------------------------------------------------------------*/

    /*-------------------------MENU' LINGUE------------------------------*/

      function openPopup() {
          document.getElementById('languagePopup').style.display = 'flex';
      }
      
      function closePopup() {
          document.getElementById('languagePopup').style.display = 'none';
      }
    
    /*-------------------------------------------------------------------*/

    /*-------------------------CAMBIA LINGUE------------------------------*/
      function changeLanguage(lang) {
      localStorage.setItem('selectedLanguage', lang);
      applyTranslations(lang);
      closePopup();
      }

      function applyTranslations(lang) {
      fetch('translations.js')
        .then(response => response.text())
        .then(script => {
          eval(script);
          const elements = document.querySelectorAll('[data-key]');
          elements.forEach(el => {
            const key = el.getAttribute('data-key');
            if (translations[lang] && translations[lang][key]) {
              if (el.tagName === "INPUT") {
                el.placeholder = translations[lang][key]; // Update placeholder for input fields
              } else {
                el.textContent = translations[lang][key];
              }
            }
          });
        });
      }

    document.addEventListener("DOMContentLoaded", () => {
      const savedLang = localStorage.getItem('selectedLanguage') || 'it';
      applyTranslations(savedLang);
    });
  
    /*-------------------------------------------------------------------*/

  </script>

<!----------------------------------------------------------------------------------------------------->




<!----------------------------------------------------------------------------------------------------->

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /*--------------------------------------------INIZIO SCRIPT---------------------------------------------*/

    // Crea la mappa
    const map = L.map('map').setView([45.6511, 9.594417], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);



    let selectedColors = { O: null, X: null, T: null };
    let shownMarkers_pref = { O: null, X: null, T: null };
    let activeButton = 'O';


    var minZoomToEdit = 17;
    var minZoomToView = 14;
    var markers = [];

/*-----------------------------------------------------------------------------------------------------------*/



//modificate un po' quasi tutte le funzioni qui (8-04-25), da copiare su facchinetti (9-04-25)
d



/*-------------------------------------------------ICONE----------------------------------------------------*/

  /*-----------------------MARKER ROSSO------------------------*/

          var redIcon = L.icon({
          iconUrl: 'RED_ICON.png', // Immagine del marker rosso
          iconSize: [35, 41], // Dimensioni del marker
          iconAnchor: [12, 41], // Punto di ancoraggio
          popupAnchor: [1, -34], // Posizione del popup
          shadowSize: [41, 41] // Dimensioni dell'ombra
          });
    
  /*-----------------------------------------------------------*/


  /*-----------------------MARKER BLU--------------------------*/

          var blueIcon = L.icon({
          iconUrl: 'BLUE_ICON.png', // Immagine del marker blu
          iconSize: [35, 41], // Dimensioni del marker
          iconAnchor: [12, 41], // Punto di ancoraggio
          popupAnchor: [1, -34], // Posizione del popup
          shadowSize: [41, 41] // Dimensioni dell'ombra
          });

  /*-----------------------------------------------------------*/

  /*-----------------------MARKER VERDE------------------------*/

          var greenIcon = L.icon({
          iconUrl: 'GREEN_ICON.png', // Immagine del marker verde
          iconSize: [35, 42], // Dimensioni del marker
          iconAnchor: [12, 41], // Punto di ancoraggio
          popupAnchor: [1, -34], // Posizione del popup
          shadowSize: [41, 41] // Dimensioni dell'ombra
          });

  /*-----------------------------------------------------------*/

  /*-----------------------MARKER ARANCIONE------------------------*/

          var orangeIcon = L.icon({
          iconUrl: 'ORANGE_ICON.png', // Immagine del marker arancione
          iconSize: [35, 40], // Dimensioni del marker
          iconAnchor: [12, 41], // Punto di ancoraggio
          popupAnchor: [1, -34], // Posizione del popup
          shadowSize: [41, 41] // Dimensioni dell'ombra
          });

  /*-----------------------------------------------------------*/

  /*-----------------------MARKER ROSA------------------------*/

          var pinkIcon = L.icon({
          iconUrl: 'PINK_ICON.png', // Immagine del marker arancione
          iconSize: [35, 41], // Dimensioni del marker
          iconAnchor: [12, 41], // Punto di ancoraggio
          popupAnchor: [1, -34], // Posizione del popup
          shadowSize: [41, 41] // Dimensioni dell'ombra
          });

  /*-----------------------------------------------------------*/


/*-----------------------------------------------------------------------------------------------------------*/




/*-----------------------------------------MENU' SCELTA MARKER-----------------------------------------------*/
    
    const menu = document.createElement('div');
    menu.className = 'marker-menu';
    menu.style.display = 'none'; // Nascondi il menu di default
    document.body.appendChild(menu);

    // Funzione per posizionare il menu contestuale
    function showMenu(x, y) {
      menu.style.left = `${x}px`;
      menu.style.top = `${y}px`;
      menu.style.display = 'block';
    }

    // Funzione per nascondere il menu contestuale
    function hideMenu() {
      menu.style.display = 'none';
    }

/*-----------------------------------------------------------------------------------------------------------*/




/*--------------------------------------PULSANTI MENU' MARKER------------------------------------------------*/

  /*--------------------PULSANTE ROSSO---------------------------*/

    const redButton = document.createElement('button');
    redButton.textContent = 'Rosso';
    redButton.style.backgroundColor = 'red';
    redButton.style.color = 'white';
    menu.appendChild(redButton);
  
  /*-------------------------------------------------------------*/

  /*--------------------PULSANTE BLU-----------------------------*/

    const blueButton = document.createElement('button');
    blueButton.textContent = 'Blu';
    blueButton.style.backgroundColor = 'blue';
    blueButton.style.color = 'white';
    menu.appendChild(blueButton);

  /*-------------------------------------------------------------*/

  /*--------------------PULSANTE VERDE---------------------------*/

    const greenButton = document.createElement('button');
    greenButton.textContent = 'Verde';
    greenButton.style.backgroundColor = 'green';
    greenButton.style.color = 'white';
    menu.appendChild(greenButton);

  /*-------------------------------------------------------------*/

  /*--------------------PULSANTE ARANCIONE---------------------------*/

    const orangeButton = document.createElement('button');
    orangeButton.textContent = 'Arancione';
    orangeButton.style.backgroundColor = 'orange';
    orangeButton.style.color = 'white';
    menu.appendChild(orangeButton);
  
  /*-------------------------------------------------------------*/

  /*--------------------PULSANTE ARANCIONE---------------------------*/

    const pinkButton = document.createElement('button');
    pinkButton.textContent = 'Rosa';
    pinkButton.style.backgroundColor = 'Pink';
    pinkButton.style.color = 'white';
    menu.appendChild(pinkButton);
  
  /*-------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------*/




/*----------------------------------------------CLICK DESTRO------------------------------------------------------*/

    // Aggiungi l'evento per il clic destro sulla mappa
    map.on('contextmenu', function (e) {
        var currentZoom = map.getZoom();
        const { x, y } = e.containerPoint; // Coordinate del clic
        showMenu(x, y); // Mostra il menu contestuale
        const latlng = e.latlng;

        if (currentZoom >= minZoomToEdit) {
        // Se il livello di zoom è sufficiente, aggiungi un marker
        var lat = e.latlng.lat;
        var lng = e.latlng.lng;

        console.log("LATITUDINE:", lat);
        console.log("LONGITUDINE:", lng);
        
        
/*-------------------------------------------------------------------------------------------------------------*/





/*----------------------------------------------EVENTI PULSANTI------------------------------------------------------*/


/*-----------------------MARKER ROSSO------------------------*/

        redButton.onclick = function () { 
            const now = new Date(); // Ora attuale al momento dell'inserimento
            const name = "Edoardo"; // Nome da aggiungere al popup
            const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';

            // Crea il marker
            var marker_r = L.marker(latlng, { icon: redIcon }).addTo(map);
            marker_r.type = "red"; // Assegna tipo

            // Calcola il tempo trascorso iniziale (solo una volta)
            const elapsed = { 
                startTime: now,
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            };
            
            console.log(`TEMPO: ${elapsed.startTime}`);
            console.log(`TIPO: ${marker_r.type}`);

            // Funzione per calcolare il tempo trascorso con traduzioni dinamiche
            function getElapsedTimeRosso(startTime, lang) {
                const currentTime = new Date();
                const elapsed = currentTime - startTime; // Differenza in millisecondi
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24);
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));

                return { startTime, days, hours, minutes, seconds };
            }

            // Funzione per aggiornare il popup
            function updatePopup(marker, startTime, type) {
                const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';
                const elapsed = getElapsedTimeRosso(startTime, lang);
                const { days, hours, minutes, seconds } = elapsed;

                let elapsedTime;
                if (days > 0) {
                    elapsedTime = `${days} ${translations[lang].giorni}, ${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}`;
                } else if (hours > 0) {
                    elapsedTime = `${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else if (minutes > 0) {
                    elapsedTime = `${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else {
                    elapsedTime = `${seconds} ${translations[lang].secondi}`;
                }

                const popupContent = `<b>${translations[lang][type]}</b> <br> 
                ${translations[lang]["utente"]}: ${name} <br> 
                ${translations[lang]["tempo_trascorso"]}: ${elapsedTime}`;

                marker.getPopup().setContent(popupContent);
            }

            // Aggiungi il popup iniziale nella lingua corretta
            marker_r.bindPopup(`<b>${translations[lang]["parcheggio_occupato"]}</b> <br> 
            ${translations[lang]["utente"]}: ${name} <br> 
            ${translations[lang]["tempo_trascorso"]}: 0 ${translations[lang]["secondi"]}`).openPopup();

            // Aggiorna il popup ogni secondo per mostrare il tempo trascorso
            setInterval(() => updatePopup(marker_r, now, "parcheggio_occupato"), 1000);

            // Funzione per applicare le traduzioni ai marker esistenti quando cambia lingua
            function applyTranslations(lang) {
                document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                    updatePopup(marker, new Date(), marker.type);
                });
            }

            hideMenu(); // Nascondi il menu dopo aver posizionato il marker
            markers.push(marker_r);
        };

    
  /*-----------------------------------------------------------*/

  /*-----------------------MARKER BLU--------------------------*/

        blueButton.onclick = function () {
            const now = new Date(); // Ora attuale al momento dell'inserimento
            const name = "Edoardo"; // Nome da aggiungere al popup
            const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';

            // Crea il marker
            var marker_r = L.marker(latlng, { icon: blueIcon }).addTo(map);
            marker_r.type = "blue"; // Assegna tipo

            // Calcola il tempo trascorso iniziale (solo una volta)
            const elapsed = { 
                startTime: now,
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            };
        
            console.log(`TEMPO: ${elapsed.startTime}`);
            console.log(`TIPO: ${marker_r.type}`);

            // Funzione per calcolare il tempo trascorso con traduzioni dinamiche
            function getElapsedTimeBlu(startTime, lang) {
                const currentTime = new Date();
                const elapsed = currentTime - startTime; // Differenza in millisecondi
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24);
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));

                return { startTime, days, hours, minutes, seconds };
            }

            // Funzione per aggiornare il popup
            function updatePopup(marker, startTime, type) {
                const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';
                const elapsed = getElapsedTimeBlu(startTime, lang);
                const { days, hours, minutes, seconds } = elapsed;

                let elapsedTime;
                if (days > 0) {
                    elapsedTime = `${days} ${translations[lang].giorni}, ${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}`;
                } else if (hours > 0) {
                    elapsedTime = `${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else if (minutes > 0) {
                    elapsedTime = `${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else {
                    elapsedTime = `${seconds} ${translations[lang].secondi}`;
                }

                const popupContent = `<b>${translations[lang][type]}</b> <br> 
                ${translations[lang]["utente"]}: ${name} <br> 
                ${translations[lang]["tempo_trascorso"]}: ${elapsedTime}`;

                marker.getPopup().setContent(popupContent);
            }

            // Aggiungi il popup iniziale nella lingua corretta
            marker_r.bindPopup(`<b>${translations[lang]["parcheggio_libero"]}</b> <br> 
            ${translations[lang]["utente"]}: ${name} <br> 
            ${translations[lang]["tempo_trascorso"]}: 0 ${translations[lang]["secondi"]}`).openPopup();

            // Aggiorna il popup ogni secondo per mostrare il tempo trascorso
            setInterval(() => updatePopup(marker_r, now, "parcheggio_libero"), 1000);

            // Funzione per applicare le traduzioni ai marker esistenti quando cambia lingua
            function applyTranslations(lang) {
                document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                    updatePopup(marker, new Date(), marker.type);
                });
            }

            hideMenu(); // Nascondi il menu dopo aver posizionato il marker
            markers.push(marker_r);
    };

  /*-----------------------------------------------------------*/

  /*-----------------------MARKER VERDE------------------------*/

        greenButton.onclick = function () {
            const now = new Date(); // Ora attuale al momento dell'inserimento
            const name = "Edoardo"; // Nome da aggiungere al popup
            const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';

            // Crea il marker
            var marker_r = L.marker(latlng, { icon: greenIcon }).addTo(map);
            marker_r.type = "green";

            // Calcola il tempo trascorso iniziale (solo una volta)
            const elapsed = { 
                startTime: now,
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            };
        
            console.log(`TEMPO: ${elapsed.startTime}`);
            console.log(`TIPO: ${marker_r.type}`);

            // Funzione per calcolare il tempo trascorso con traduzioni dinamiche
            function getElapsedTimeVerde(startTime, lang) {
                const currentTime = new Date();
                const elapsed = currentTime - startTime; // Differenza in millisecondi
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24);
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));

                return { startTime, days, hours, minutes, seconds };
            }

            // Funzione per aggiornare il popup
            function updatePopup(marker, startTime, type) {
                const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';
                const elapsed = getElapsedTimeVerde(startTime, lang);
                const { days, hours, minutes, seconds } = elapsed;

                let elapsedTime;
                if (days > 0) {
                    elapsedTime = `${days} ${translations[lang].giorni}, ${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}`;
                } else if (hours > 0) {
                    elapsedTime = `${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else if (minutes > 0) {
                    elapsedTime = `${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else {
                    elapsedTime = `${seconds} ${translations[lang].secondi}`;
                }

                const popupContent = `<b>${translations[lang][type]}</b> <br> 
                ${translations[lang]["utente"]}: ${name} <br> 
                ${translations[lang]["tempo_trascorso"]}: ${elapsedTime}`;

                marker.getPopup().setContent(popupContent);
            }

            // Aggiungi il popup iniziale nella lingua corretta
            marker_r.bindPopup(`<b>${translations[lang]["ascensore"]}</b> <br> 
            ${translations[lang]["utente"]}: ${name} <br> 
            ${translations[lang]["tempo_trascorso"]}: 0 ${translations[lang]["secondi"]}`).openPopup();

            // Aggiorna il popup ogni secondo per mostrare il tempo trascorso
            setInterval(() => updatePopup(marker_r, now, "ascensore"), 1000);

            // Funzione per applicare le traduzioni ai marker esistenti quando cambia lingua
            function applyTranslations(lang) {
                document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                    updatePopup(marker, new Date(), marker.type);
                });
            }

            hideMenu(); // Nascondi il menu dopo aver posizionato il marker
            markers.push(marker_r);
    };

    /*-----------------------------------------------------------*/

    /*-----------------------MARKER ARANCIONE------------------------*/

        orangeButton.onclick = function () {
            const now = new Date(); // Ora attuale al momento dell'inserimento
            const name = "Edoardo"; // Nome da aggiungere al popup
            const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';

            // Crea il marker
            var marker_r = L.marker(latlng, { icon: orangeIcon }).addTo(map);
            marker_r.type = "orange"; // Assegna tipo

        // Calcola il tempo trascorso iniziale (solo una volta)
            const elapsed = { 
                startTime: now,
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            };
        
            console.log(`TEMPO: ${elapsed.startTime}`);
            console.log(`TIPO: ${marker_r.type}`);

            // Funzione per calcolare il tempo trascorso con traduzioni dinamiche
            function getElapsedTimeArancione(startTime, lang) {
                const currentTime = new Date();
                const elapsed = currentTime - startTime; // Differenza in millisecondi
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24);
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));

                return { startTime, days, hours, minutes, seconds };
            }

            // Funzione per aggiornare il popup
            function updatePopup(marker, startTime, type) {
                const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';
                const elapsed = getElapsedTimeArancione(startTime, lang);
                const { days, hours, minutes, seconds } = elapsed;

                let elapsedTime;
                if (days > 0) {
                    elapsedTime = `${days} ${translations[lang].giorni}, ${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}`;
                } else if (hours > 0) {
                    elapsedTime = `${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else if (minutes > 0) {
                    elapsedTime = `${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else {
                    elapsedTime = `${seconds} ${translations[lang].secondi}`;
                }

                const popupContent = `<b>${translations[lang][type]}</b> <br> 
                ${translations[lang]["utente"]}: ${name} <br> 
                ${translations[lang]["tempo_trascorso"]}: ${elapsedTime}`;

                marker.getPopup().setContent(popupContent);
            }

            // Aggiungi il popup iniziale nella lingua corretta
            marker_r.bindPopup(`<b>${translations[lang]["hotel"]}</b> <br> 
            ${translations[lang]["utente"]}: ${name} <br> 
            ${translations[lang]["tempo_trascorso"]}: 0 ${translations[lang]["secondi"]}`).openPopup();

            // Aggiorna il popup ogni secondo per mostrare il tempo trascorso
            setInterval(() => updatePopup(marker_r, now, "hotel"), 1000);

            // Funzione per applicare le traduzioni ai marker esistenti quando cambia lingua
            function applyTranslations(lang) {
                document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                    updatePopup(marker, new Date(), marker.type);
                });
            }

            hideMenu(); // Nascondi il menu dopo aver posizionato il marker
            markers.push(marker_r);
    };        

    /*-----------------------------------------------------------*/

    /*-----------------------MARKER ROSA------------------------*/

        pinkButton.onclick = function () {
            const now = new Date(); // Ora attuale al momento dell'inserimento
            const name = "Edoardo"; // Nome da aggiungere al popup
            const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';

            // Crea il marker
            var marker_r = L.marker(latlng, { icon: pinkIcon }).addTo(map);
            marker_r.type = "pink"; // Assegna tipo

            // Calcola il tempo trascorso iniziale (solo una volta)
            const elapsed = { 
                startTime: now,
                days: 0,
                hours: 0,
                minutes: 0,
                seconds: 0
            };
        
            console.log(`TEMPO: ${elapsed.startTime}`);
            console.log(`TIPO: ${marker_r.type}`);

            // Funzione per calcolare il tempo trascorso con traduzioni dinamiche
            function getElapsedTimeRosa(startTime, lang) {
                const currentTime = new Date();
                const elapsed = currentTime - startTime; // Differenza in millisecondi
                const seconds = Math.floor((elapsed / 1000) % 60);
                const minutes = Math.floor((elapsed / (1000 * 60)) % 60);
                const hours = Math.floor((elapsed / (1000 * 60 * 60)) % 24);
                const days = Math.floor(elapsed / (1000 * 60 * 60 * 24));

                return { startTime, days, hours, minutes, seconds };
            }

            // Funzione per aggiornare il popup
            function updatePopup(marker, startTime, type) {
                const lang = localStorage.getItem('selectedLanguage') || document.documentElement.lang || navigator.language.slice(0, 2) || 'en';
                const elapsed = getElapsedTimeRosa(startTime, lang);
                const { days, hours, minutes, seconds } = elapsed;

                let elapsedTime;
                if (days > 0) {
                    elapsedTime = `${days} ${translations[lang].giorni}, ${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}`;
                } else if (hours > 0) {
                    elapsedTime = `${hours} ${translations[lang].ore}, ${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else if (minutes > 0) {
                    elapsedTime = `${minutes} ${translations[lang].minuti}, ${seconds} ${translations[lang].secondi}`;
                } else {
                    elapsedTime = `${seconds} ${translations[lang].secondi}`;
                }

                const popupContent = `<b>${translations[lang][type]}</b> <br> 
                ${translations[lang]["utente"]}: ${name} <br> 
                ${translations[lang]["tempo_trascorso"]}: ${elapsedTime}`;

                marker.getPopup().setContent(popupContent);
            }

            // Aggiungi il popup iniziale nella lingua corretta
            marker_r.bindPopup(`<b>${translations[lang]["servizi_igenici"]}</b> <br> 
            ${translations[lang]["utente"]}: ${name} <br> 
            ${translations[lang]["tempo_trascorso"]}: 0 ${translations[lang]["secondi"]}`).openPopup();

            // Aggiorna il popup ogni secondo per mostrare il tempo trascorso
            setInterval(() => updatePopup(marker_r, now, "servizi_igenici"), 1000);

            // Funzione per applicare le traduzioni ai marker esistenti quando cambia lingua
            function applyTranslations(lang) {
                document.querySelectorAll('.leaflet-marker-icon').forEach(marker => {
                    updatePopup(marker, new Date(), marker.type);
                });
            }

            hideMenu(); // Nascondi il menu dopo aver posizionato il marker
            markers.push(marker_r);
        };        

    /*-----------------------------------------------------------*/


/*-----------------UPDATE LINGUA MARKER-------------------------------*/

    // Ascolta il cambio lingua e aggiorna i marker
    document.addEventListener("languageChanged", (event) => {
        const newLang = event.detail.newLang;
        applyTranslations(newLang);
    });

      // Funzione per cambiare lingua e aggiornare il sito
    function changeLanguage(newLang) {
        localStorage.setItem('selectedLanguage', newLang);
        document.dispatchEvent(new CustomEvent("languageChanged", { detail: { newLang } }));
    }
  
    } else 
        hideMenu();
    });

/*-----------------------------------------------------------------------------------------------------------*/




/*-----------------------------------------COMPORTAMENTO MARKER----------------------------------------------*/

  /*--------------------ZOOM MAPPA-----------------------------*/

    map.on('zoomend', function () {
      var currentZoom = map.getZoom();

  /*-----------------------------------------------------------*/


  /*--------------------MARKER OFF-----------------------------*/

      if (currentZoom < minZoomToView ) {
        markers.forEach(function(marker) {
          marker.setOpacity(0); // Nascondi il marker
          marker.closePopup()
        });
        hideMenu();
      } 
      
  /*-----------------------------------------------------------*/


  /*--------------------MARKER ON------------------------------*/

      else {
        // Se il livello di zoom è sufficiente, mostra i marker
        markers.forEach(function(marker) {
          marker.setOpacity(1); // Mostra il marker
        });
      }

    });

  /*-----------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------*/



/*----------------------------------------------NASCONDI------------------------------------------------------*/

        map.on('click', hideMenu);
        document.body.addEventListener('click', function (e) {
        if (!menu.contains(e.target)) {
            hideMenu();
        }
    });

/*-----------------------------------------------------------------------------------------------------------*/




  </script>
</body>

<!----------------------------------------------FINE BODY----------------------------------------------------->

</html>
